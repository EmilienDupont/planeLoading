<!DOCTYPE html>
<meta charset="utf-8">
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script>
  MathJax.Hub.Config({
                      tex2jax: {inlineMath: [['$', '$'], ['\\(','\\)']]},
                      TeX: { equationNumbers: {autoNumber: "AMS"} },
                      "HTML-CSS": { showMathMenu: false,
                                    scale: 90 }
                     });
</script>
<link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.4.2/pure-min.css">
<style>

@import url(http://fonts.googleapis.com/css?family=PT+Serif|PT+Serif:b|PT+Serif:i|PT+Sans|PT+Sans:b);
@import url(http://fonts.googleapis.com/css?family=Lato);
html {
   min-width: 1040px;
}

body {
   background: #fcfcfa;
   color: #333;
   font-family: "PT Serif", serif;
   /*margin: 0 1em 4em auto;*/
   position: relative;
   width: 960px;
   left: 13em;
}

h1, h2, h3, h4 { font-family: "Lato", "PT Serif", serif; color: #000; text-rendering: optimizeLegibility; }

h1 {
  font-size: 64px;
  line-height: 73px;
  font-weight: 900;
  margin-top: 0.67em;
  margin-right: 0;
  margin-bottom: 0;
  margin-left: 0;
}

h2 {
   margin-top: 2em;
}

subtitle {
   display:block;
   font-family: "PT Serif", serif;
   font-size: 32px;
   font-style: italic;
   font-weight: 100;
}

p {
  line-height: 150%;
  width: 720px;
}

a {
  color: steelblue;
  cursor: auto;
}

a:not(:hover) {
   text-decoration: none;
}

pre {
   border-left: solid 2px #ccc;
   padding-left: 18px;
   margin: 2em 0 2em -20px;
}

aside {
   font-size: small;
   right: 0;
   position: absolute;
   width: 180px;
}

#nav {
        left: 5px;
        font-family: "Lato", serif;
        font-weight: 700;
        list-style: none;
        margin: 0;
        position: fixed;
        top: 10px;
        box-sizing: border-box;
}


#nav li {
        margin-bottom: 0px;
}

#nav a {
        color: #333;
        display: block;
        font-size: 14px;
        border-left: 3px solid #fcfcfa;
        padding: 5px 10px;
        text-decoration: none;
}

#nav a:hover {
   border-left: 3px solid steelblue;
}

#nav .current a {
   border-left: 3px solid steelblue;
}

</style>
<body>
  <ul id="nav">
    <li class="current"><a href="#intro">Intro</a></li>
    <li><a href="#problem">Problem</a></li>
    <li><a href="#model">Model</a></li>
    <li><a href="#implementation">Implementation</a></li>
    <li><a href="#demo">Live Demo</a></li>
  </ul>
  <div id="container">
    <div class="section" id="intro">
      <h1>Cargo Plane Loading</h1>
        <subtitle>with integer programming and Gurobi</subtitle>
    </div>

    <div class="section" id="problem">
      <h2><a href="#problem" name="problem">Problem Description</a></h2>
      Problem description goes here

    </div>
    <div class="section" id="model">
      <h2><a href="#model" name="model">Mathematical Model</a></h2>

      <p>Model description goes here.</p>

    </div>
    <div class="section" id="implementation">
      <h2><a href="#implementation" name="implementation">Implementation</a></h2>
      <p>Below is the full implementation of the model (and the associated data) in
        Gurobi's Python interface:
      </p>
      <pre>
      Gurobi Code
      </pre>
    </div>
    <div class="section" id="demo">
      <h2><a href="#demo" name="demo">Live Demo</a></h2>
      <div id="demoarea">
      </div>
      <button class="pure-button" onclick="compute()">Compute</button>
      <div>Icons made by <a href="http://www.flaticon.com/authors/google" title="Google">Google</a>
      from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a>
      is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0">CC BY 3.0</a></div>
    </div>

    <div style="min-height:100px"></div>

<!--[if gt IE 8]><!--><script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script><!--<![endif]-->
<script src="http://davist11.github.io/jQuery-One-Page-Nav/jquery.nav.js"></script>
<script>
  $(document).ready(function() {
  console.log('calling onePageNav');
  $('#nav').onePageNav();
  });
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script>

//Width and height
var width = 800;
var height = 500;

var svg = d3.select("#demoarea")
              .append("svg")
              .attr("width", width)
              .attr("height", height);

// Data for problem
var box = [17,21,5,4];
var planes = [100,100,100];
var boxWeights = [1,2,3,6]; // in tonnes
var boxes = [];
var boxScale = 3.8;

// G object for background
backgroundG = svg.append("g");

// G object for planes
planesG = svg.append("g");

// G objects for menu
menuG = svg.append("g");
menu2G = svg.append("g");

// G objects for buttons
buttonsPlusG = svg.append("g");
buttonsMinusG = svg.append("g");

// G object for buttontext
buttontxtG = svg.append("g");

// G object for storage box
storageG = svg.append("g");

// G object for different planes
plane0G = svg.append("g");
plane1G = svg.append("g");
plane2G = svg.append("g");
var planesG = [plane0G, plane1G, plane2G];

// Create background
backgroundG.append("rect")
           .attr("x", 0).attr("y", 0)
           .attr("width", width).attr("height", height)
           .attr("fill", "rgb(255,250,205)");

var planeGraphics = [[0, .65*height], [.19*width, .8*height], [.38*width, .95*height]];
/*
planesG.selectAll("path")
          .data(planeGraphics)
          .enter()
          .append("path")
          .attr("d", "M510,255c0-20.4-17.85-38.25-38.25-38.25H331.5L204,12.75h-51l63.75,204H76.5l-38.25-51H0L25.5,255L0,344.25h38.25    l38.25-51h140.25l-63.75,204h51l127.5-204h140.25C492.15,293.25,510,275.4,510,255z")
          .attr("transform", function(d) { return "translate(" + d[0] + "," + d[1] + ") rotate(-90) scale(.6)"; })
          .attr("fill", "white")
          .attr("stroke", "black")
          .attr("opacity", .5); */

// Create menu
menu = [];
menuNum = 4;
menuPad = 100;
menuH = height/7;
menuW = width/10;
boxSize = [menuH/2, menuH/3, menuH/4, menuH/5];
buttonSize = 30;

for (var i = 0; i < menuNum; i++) {
  menu.push([.8*width, i*(height - 2*menuPad)/(menuNum - 1) + menuPad]);
}

menuG.selectAll("rect")
     .data(menu)
     .enter()
     .append("rect")
     .attr("x", function(d) { return d[0]; })
     .attr("y", function(d) { return d[1] - menuH/2; })
     .attr("height", menuH )
     .attr("width", menuW )
     .attr("fill", "rgb(245,222,179)")
     .attr("stroke", "rgb(225,202,149)")
     .attr("stroke-width", 3);

menu2G.selectAll("rect")
     .data(menu)
     .enter()
     .append("rect")
     .attr("x", function(d,i) { return d[0] + menuW/2 - boxSize[i]/2; })
     .attr("y", function(d,i) { return d[1] - menuH/2 + (i+1)*menuH/10; })
     .attr("height", function(d,i) { return boxSize[i]; } )
     .attr("width", function(d,i) { return boxSize[i]; } )
     .attr("fill", "rgb(225,202,149)")
     .attr("stroke", "rgb(205,182,129)")
     .attr("stroke-width", 3);

buttonsPlusG.selectAll("rect")
     .data(menu)
     .enter()
     .append("rect")
     .attr("x", function(d) { return d[0] + menuW; })
     .attr("y", function(d) { return d[1] - buttonSize/2; })
     .attr("height", buttonSize )
     .attr("width", buttonSize )
     .attr("fill", "rgb(225,202,149)")
     .attr("stroke", "rgb(205,182,129)")
     .attr("stroke-width", 3)
     .attr("id", function(d,i) { return i; })
     .on("mousedown", addBox);

buttonsPlusG.selectAll("text")
     .data(menu)
     .enter()
     .append("text")
     .attr("x", function(d) { return d[0] + menuW + buttonSize/2; })
     .attr("y", function(d) { return d[1] + .35*buttonSize; })
     .attr("fill", "rgb(0,220,0)")
     .attr("stroke", "rgb(0,180,0)")
     .text("+")
     .attr("font-size", 30)
     .attr("font-weight", 700)
     .attr("text-anchor", "middle")
     .attr("id", function(d,i) { return i; })
     .on("mousedown", addBox);

buttonsMinusG.selectAll("rect")
     .data(menu)
     .enter()
     .append("rect")
     .attr("x", function(d) { return d[0] - buttonSize; })
     .attr("y", function(d) { return d[1] - buttonSize/2; })
     .attr("height", buttonSize )
     .attr("width", buttonSize )
     .attr("fill", "rgb(225,202,149)")
     .attr("stroke", "rgb(205,182,129)")
     .attr("stroke-width", 3)
     .attr("id", function(d,i) { return i; })
     .on("mousedown", removeBox);

buttonsMinusG.selectAll("text")
     .data(menu)
     .enter()
     .append("text")
     .attr("x", function(d) { return d[0] - buttonSize/2; })
     .attr("y", function(d) { return d[1] + .35*buttonSize; })
     .attr("fill", "rgb(220,0,0)")
     .attr("stroke", "rgb(180,0,0)")
     .text("-")
     .attr("font-size", 30)
     .attr("font-weight", 700)
     .attr("text-anchor", "middle")
     .attr("id", function(d,i) { return i; })
     .on("mousedown", removeBox);

redraw();

var storage = [[.1*width, .2*height], [.3*width, .2*height], [.5*width, .2*height]]
var storageW = .15*width;
var storageH = .6*height;

// Create storage rectangles
storageG.selectAll("rect")
        .data(storage)
        .enter()
        .append("rect")
        .attr("x", function (d) { return d[0]; })
        .attr("y", function (d) { return d[1]; })
        .attr("height", storageH)
        .attr("width", storageW)
        .attr("opacity", .3);

function addBox() {
  var id = parseInt(d3.select(this).attr("id"));
  box[id] += 1;
  redraw();
}

function removeBox() {
  var id = parseInt(d3.select(this).attr("id"));
  if (box[id] > 0) {
    box[id] -= 1;
  }
  redraw();
}

function redraw() {
  buttontxtG.selectAll("text").remove("text");
  buttontxtG.selectAll("text")
            .data(box)
            .enter()
            .append("text")
            .attr("x", function(d,i) { return menu[i][0] + menuW/2; })
            .attr("y", function(d,i) { return menu[i][1] + .4*menuH; })
            .text(function(d) {return d;})
            .attr("text-anchor", "middle")
            .attr("font-family", "Helvetica Neue")
            .attr("font-weight", 800)
            .attr("font-size", 15)
            .attr("fill", "white");
}

function compute() {
  boxes = [];
  for (var j = 0; j < 4; j++) {
    for (var i = 0; i < box[j]; i++) {
      boxes.push(boxWeights[j]);
    }
  }

  console.log('boxes',boxes);

  d3.json('/planeLoading.py')
    .header('Content-Type', 'application/json')
    .post(JSON.stringify({'planes': planes, 'boxes': boxes}), serverResponse);
}

function serverResponse(error, data) {
  console.log('serverResponse');
  console.log('data', data);
  if (!error) {
    if ('solution' in data) {
        // Import solution and put it into correct format
        var solution = data['solution'];
        console.log('solution', solution);

        // Calculate total weight in each plane
        var weight = [0,0,0];
        for (var i = 0; i < solution.length; i++) {
          for (var j = 0; j < solution[i].length; j++) {
            weight[i] = weight[i] + boxes[solution[i][j]];
          }
        }
        console.log('weight', weight);

        for (var j = 0; j < planesG.length; j++) {
          planesG[j].selectAll("rect").remove("rect");
          planesG[j].selectAll("rect")
                 .data(solution[j])
                 .enter()
                 .append("rect")
                 .attr("x", function(d,i) { return storage[j][0] + (i%4 + .5)*storageW/4 - boxScale*boxes[d]/2; })
                 .attr("y", function(d,i) { return storage[j][1] - Math.floor(i/4)*storageH/10 + .95*storageH - boxScale*boxes[d]/2; })
                 .attr("height", function(d) { return boxScale*boxes[d];})
                 .attr("width", function(d) { return boxScale*boxes[d];})
                 .attr("fill", "rgb(225,202,149)")
                 .attr("stroke", "rgb(205,182,129)")
                 .attr("stroke-width", 3)
                 .attr("opacity", 0)
                 .transition()
                 .duration(500)
                 .delay(function(d, i) { return i*50; })
                 .attr("opacity", 1);

          planesG[j].append("text")
                 .attr("x", storage[j][0] + storageW/2)
                 .attr("y", .85*height)
                 .text(weight[j]);

          planesG[j].append("text")
                 .attr("x", storage[j][0] + storageW/2)
                 .attr("y", .9*height)
                 .text("Tonnes");

          planesG[j].selectAll("text")
                 .attr("text-anchor", "middle")
                 .attr("font-family", "Helvetica Neue")
                 .attr("font-weight", 800)
                 .attr("font-size", 20);
        }

    }
  }
}

</script>
